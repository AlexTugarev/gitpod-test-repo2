# debug using `werft run github -f -j .werft/changelog.yaml -a debug=true`
pod:
  serviceAccount: werft
  nodeSelector:
    cloud.google.com/gke-nodepool: builds
  containers:
  - name: build
    image: eu.gcr.io/gitpod-core-dev/dev/changelog:0.0.1
    workingDir: /workspace
    imagePullPolicy: Always
    env:
    - name: GITHUB_USER
      value: gitpod
    - name: GITHUB_EMAIL
      value: service+github@gitpod.io
    - name: GITHUB_TOKEN
      valueFrom:
        secretKeyRef:
          name: github-sh-release-token
          key: token
    command:
      - bash
      - -c
      - |
        sleep 1
        set -Eeuo pipefail

        export GITHUB_TOKEN=$(echo $GITHUB_TOKEN | xargs)
        /app/changelog -t $GITHUB_TOKEN -o {{ .Repository.Owner }} -r {{ .Repository.Repo }} -f CHANGELOG.md
        git config --global user.name $GITHUB_USER
        git config --global user.email $GITHUB_EMAIL
        git config --global credential.helper '/bin/sh -c "echo username=$GITHUB_USER; echo password=$GITHUB_TOKEN"'
        git add CHANGELOG.md
        git commit -m "[changelog] updated changelog"
        git push
